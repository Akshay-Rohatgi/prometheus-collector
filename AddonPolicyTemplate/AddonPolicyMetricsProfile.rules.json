{
	"if": {
	  "field": "type",
	  "equals": "Microsoft.ContainerService/managedClusters"
	},
	"then": {
	  "effect": "deployIfNotExists",
	  "details": {
		"type": "Microsoft.ContainerService/managedClusters",
		"name": "[field('name')]",
		"roleDefinitionIds": [
			"/providers/Microsoft.Authorization/roleDefinitions/ed7f3fbd-7b88-4dd4-9017-9adb7ce333f8",
			"/providers/Microsoft.Authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa"
		],
		"existenceCondition": {
		  "field": "Microsoft.ContainerService/managedClusters/azureMonitorProfile.metrics.enabled",
		  "equals": "true"
		},
		"deployment": {
		  "properties": {
			"mode": "incremental",
			"template": {
			  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
			  "contentVersion": "1.0.0.0",
			  "parameters": {
				"azureMonitorWorkspaceResourceId": {
				  "type": "string"
				},
				"azureMonitorWorkspaceLocation": {
					"type": "string",
					"defaultValue": "",
					"allowedValues": [
					  "eastus2euap",
					  "centraluseuap",
					  "centralus",
					  "eastus",
					  "eastus2",
					  "northeurope",
					  "southcentralus",
					  "southeastasia",
					  "uksouth",
					  "westeurope",
					  "westus",
					  "westus2"
					]
				},
				"metricLabelsAllowlist": {
				  "type": "string"
				},
				"metricAnnotationsAllowList": {
				  "type": "string"
				}
			  },
			  "variables": {
				"clusterSubscriptionId": "[split([field('id')]),'/')[2]]",
				"clusterResourceGroup": "[split([field('id')]),'/')[4]]",
				"clusterName": "[field('name')]",
				"dceName": "[Concat('MSProm', '-', parameters('azureMonitorWorkspaceLocation'), '-', variables('clusterName'))]",
				"dcrName": "[Concat('MSProm', '-', parameters('azureMonitorWorkspaceLocation'), '-', variables('clusterName'))]",
				"dcraName": "[Concat('MSProm', '-', [field('location')], '-', variables('clusterName'))]",
				"nodeRecordingRuleGroup": "NodeRecordingRulesRuleGroup-",
				"nodeRecordingRuleGroupName": "[concat(variables('nodeRecordingRuleGroup'), variables('clusterName'))]",
				"nodeRecordingRuleGroupDescription": "Node Recording Rules RuleGroup",
				"kubernetesRecordingRuleGroup": "KubernetesReccordingRulesRuleGroup-",
				"kubernetesRecordingRuleGroupName": "[concat(variables('kubernetesRecordingRuleGroup'), variables('clusterName'))]",
				"kubernetesRecordingRuleGroupDescription": "Kubernetes Recording Rules RuleGroup",
				"version": " - 0.1"
			  },
			  "resources": [
				{
				  "type": "Microsoft.Insights/dataCollectionEndpoints",
				  "apiVersion": "2021-09-01-preview",
				  "name": "[variables('dceName')]",
				  "location": "[parameters('azureMonitorWorkspaceLocation')]",
				  "kind": "Linux",
				  "properties": {}
				},
				{
				  "type": "Microsoft.Insights/dataCollectionRules",
				  "apiVersion": "2021-09-01-preview",
				  "name": "[variables('dcrName')]",
				  "location": "[parameters('azureMonitorWorkspaceLocation')]",
				  "kind": "Linux",
				  "properties": {
					"dataCollectionEndpointId": "[resourceId('Microsoft.Insights/dataCollectionEndpoints/', variables('dceName'))]",
					"dataFlows": [
					  {
						"destinations": [
						  "MonitoringAccount1"
						],
						"streams": [
						  "Microsoft-PrometheusMetrics"
						]
					  }
					],
					"dataSources": {
					  "prometheusForwarder": [
						{
						  "name": "PrometheusDataSource",
						  "streams": [
							"Microsoft-PrometheusMetrics"
						  ],
						  "labelIncludeFilter": {}
						}
					  ]
					},
					"description": "DCR for Azure Monitor Metrics Profile (Managed Prometheus)",
					"destinations": {
					  "monitoringAccounts": [
						{
						  "accountResourceId": "[parameters('azureMonitorWorkspaceResourceId')]",
						  "name": "MonitoringAccount1"
						}
					  ]
					}
				  },
				  "dependsOn": [
					"[resourceId('Microsoft.Insights/dataCollectionEndpoints/', variables('dceName'))]"
				  ]
				},
				{
				  "type": "Microsoft.Resources/deployments",
				  "name": "[Concat('azuremonitormetrics-dcra', '-',  uniqueString([field('id')]))]",
				  "apiVersion": "2017-05-10",
				  "subscriptionId": "[variables('clusterSubscriptionId')]",
				  "resourceGroup": "[variables('clusterResourceGroup')]",
				  "dependsOn": [
					"[resourceId('Microsoft.Insights/dataCollectionEndpoints/', variables('dceName'))]",
					"[resourceId('Microsoft.Insights/dataCollectionRules', variables('dcrName'))]"
				  ],
				  "properties": {
					"mode": "Incremental",
					"template": {
					  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
					  "contentVersion": "1.0.0.0",
					  "parameters": {},
					  "variables": {},
					  "resources": [
						{
						  "type": "Microsoft.ContainerService/managedClusters/providers/dataCollectionRuleAssociations",
						  "name": "[concat(variables('clusterName'),'/microsoft.insights/', variables('dcraName'))]",
						  "apiVersion": "2021-09-01-preview",
						  "location": "[field('location')]",
						  "properties": {
							"description": "Association of data collection rule. Deleting this association will break the data collection for this AKS Cluster.",
							"dataCollectionRuleId": "[resourceId('Microsoft.Insights/dataCollectionRules', variables('dcrName'))]"
						  }
						}
					  ]
					},
					"parameters": {}
				  }
				},
				{
				  "type": "Microsoft.Resources/deployments",
				  "name": "[Concat('azuremonitormetrics-profile-', '-',  uniqueString([field('id')]))]",
				  "apiVersion": "2017-05-10",
				  "subscriptionId": "[variables('clusterSubscriptionId')]",
				  "resourceGroup": "[variables('clusterResourceGroup')]",
				  "dependsOn": [
					"[Concat('azuremonitormetrics-dcra', '-',  uniqueString([field('id')]))]"
				  ],
				  "properties": {
					"mode": "Incremental",
					"template": {
					  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
					  "contentVersion": "1.0.0.0",
					  "parameters": {},
					  "variables": {},
					  "resources": [
						{
						  "name": "[field('name')]",
						  "type": "Microsoft.ContainerService/managedClusters",
						  "location": "[field('location')]",
						  "apiVersion": "2022-07-02-preview",
						  "properties": {
							"mode": "Incremental",
							"id": "[field('id')]",
							"azureMonitorProfile": {
							  "metrics": {
								"enabled": true,
								"kubeStateMetrics": {
								  "metricLabelsAllowlist": "[parameters('metricLabelsAllowlist')]",
								  "metricAnnotationsAllowList": "[parameters('metricAnnotationsAllowList')]"
								}
							  }
							}
						  }
						}
					  ]
					},
					"parameters": {}
				  }
				}
			  ]
			},
			"parameters": {
			  "azureMonitorWorkspaceResourceId": {
				"value": "[parameters('azureMonitorWorkspaceResourceId')]"
			  },
			  "azureMonitorWorkspaceLocation": {
				"value": "[parameters('azureMonitorWorkspaceLocation')]"
			  },
			  "metricLabelsAllowlist": {
				"value": "[parameters('metricLabelsAllowlist')]"
			  },
			  "metricAnnotationsAllowList": {
				"value": "[parameters('metricAnnotationsAllowList')]"
			  }
			}
		  }
		}
	  }
	}
  }
